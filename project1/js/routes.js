//Coordinate data and mapping
//Coordinates data can be found here http://bl.ocks.org/karmadude/5820393
var data = {
    "features": [{
        "geometry": {
            "geometries": [{
                "coordinates": [[[-122.391701, 37.794113], [-122.39198, 37.793906], [-122.391614, 37.793571], [-122.391714, 37.793459], [-122.388816, 37.791005], [-122.388932, 37.790919], [-122.388616, 37.790348], [-122.388076, 37.790518], [-122.388375, 37.790334], [-122.388225, 37.790032], [-122.385852, 37.790951], [-122.385496, 37.790559], [-122.387589, 37.789838], [-122.387289, 37.789347], [-122.385303, 37.789838], [-122.38512, 37.789313], [-122.387174, 37.788807], [-122.387032, 37.788255], [-122.385261, 37.788537], [-122.385136, 37.788156], [-122.38739, 37.787736], [-122.387415, 37.787269], [-122.3845, 37.787437], [-122.384342, 37.785728], [-122.387577, 37.785485], [-122.38765, 37.784929], [-122.385546, 37.785009], [-122.385455, 37.784711], [-122.387477, 37.784493], [-122.387691, 37.784412], [-122.387722, 37.783928], [-122.385271, 37.784049], [-122.38525, 37.78379], [-122.38572, 37.783774], [-122.38573, 37.78354], [-122.386088, 37.783435], [-122.387732, 37.783282], [-122.387773, 37.782911], [-122.388426, 37.781801], [-122.388189, 37.784771], [-122.388504, 37.785348], [-122.389694, 37.786243], [-122.39141, 37.785103], [-122.39146, 37.7855], [-122.393512, 37.784564], [-122.394567, 37.783783], [-122.396711, 37.785549], [-122.398941, 37.783785], [-122.400955, 37.785389], [-122.399523, 37.786631], [-122.39999, 37.787004], [-122.401497, 37.785824], [-122.403374, 37.787401], [-122.403427, 37.787676], [-122.393875, 37.795248], [-122.392429, 37.793835], [-122.391701, 37.794113]]],
                "type": "Polygon"
            }],
            "type": "GeometryCollection"
        },
        "id": "94105",
        "properties": {
            "id": "94105",
            "name": "Financial District"
        },
        "type": "Feature"
    },
        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.387773, 37.782911], [-122.38474, 37.782975], [-122.401768, 37.769145], [-122.401685, 37.769721], [-122.402091, 37.769716], [-122.402105, 37.769912], [-122.403477, 37.769842], [-122.404003, 37.77018], [-122.403723, 37.770182], [-122.399425, 37.773612], [-122.405629, 37.778502], [-122.396711, 37.785549], [-122.394567, 37.783783], [-122.393512, 37.784564], [-122.39146, 37.7855], [-122.39141, 37.785103], [-122.389694, 37.786243], [-122.388504, 37.785348], [-122.388189, 37.784771], [-122.388426, 37.781801], [-122.387773, 37.782911]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94107",
            "properties": {
                "id": "94107",
                "name": "Potrero Hill"
            },
            "type": "Feature"
        },
        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.404959, 37.795337], [-122.404055, 37.790751], [-122.402694, 37.790937], [-122.402535, 37.790006], [-122.403858, 37.789819], [-122.403478, 37.787965], [-122.403247, 37.787814], [-122.405883, 37.785718], [-122.406236, 37.785793], [-122.406602, 37.787583], [-122.408244, 37.787369], [-122.408655, 37.789244], [-122.411913, 37.788812], [-122.41229, 37.790669], [-122.413931, 37.79047], [-122.414883, 37.79503], [-122.411553, 37.795409], [-122.411484, 37.795033], [-122.411024, 37.795145], [-122.411087, 37.795467], [-122.407091, 37.79597], [-122.407014, 37.795587], [-122.406591, 37.795697], [-122.406649, 37.796027], [-122.40568, 37.796152], [-122.405526, 37.795292], [-122.404959, 37.795337]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94108",
            "properties": {
                "id": "94108",
                "name": "Chinatown"
            },
            "type": "Feature"
        },
        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.420432, 37.808308], [-122.420342, 37.807746], [-122.420746, 37.807598], [-122.419084, 37.807804], [-122.418879, 37.806877], [-122.4196, 37.806783], [-122.418789, 37.806249], [-122.418349, 37.804101], [-122.418468, 37.804109], [-122.418129, 37.803168], [-122.417893, 37.80172], [-122.419167, 37.801559], [-122.419075, 37.801144], [-122.417814, 37.80132], [-122.417548, 37.799967], [-122.418252, 37.799884], [-122.418226, 37.799295], [-122.41741, 37.799405], [-122.417224, 37.798494], [-122.415574, 37.798688], [-122.413931, 37.79047], [-122.41229, 37.790669], [-122.411712, 37.78787], [-122.413356, 37.787657], [-122.413165, 37.786726], [-122.414805, 37.786523], [-122.414256, 37.783728], [-122.427427, 37.782055], [-122.430001, 37.794906], [-122.423491, 37.795723], [-122.42553, 37.805821], [-122.425374, 37.806107], [-122.425397, 37.806565], [-122.426352, 37.807528], [-122.425528, 37.806976], [-122.424292, 37.806622], [-122.423469, 37.80678], [-122.422145, 37.80759], [-122.421381, 37.808188], [-122.42109, 37.808549], [-122.421123, 37.808812], [-122.422852, 37.810176], [-122.422752, 37.810251], [-122.421319, 37.809178], [-122.421194, 37.809232], [-122.420906, 37.808818], [-122.420739, 37.808837], [-122.420764, 37.809105], [-122.420323, 37.809002], [-122.420639, 37.80884], [-122.42032, 37.808739], [-122.420514, 37.808645], [-122.420432, 37.808308]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94109",
            "properties": {
                "id": "94109",
                "name": "Polk/Russian Hill (Nob Hill)"
            },
            "type": "Feature"
        },
        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[[-122.419083, 37.811572], [-122.415375, 37.809166], [-122.415194, 37.809226], [-122.415403, 37.809424], [-122.415085, 37.809231], [-122.414794, 37.809331], [-122.415315, 37.809767], [-122.415212, 37.809848], [-122.413444, 37.809247], [-122.413371, 37.809391], [-122.414276, 37.809863], [-122.414024, 37.81014], [-122.413789, 37.809946], [-122.413868, 37.809874], [-122.412638, 37.809089], [-122.41239, 37.809118], [-122.411911, 37.809384], [-122.412856, 37.810523], [-122.412717, 37.810604], [-122.411402, 37.809035], [-122.41056, 37.808843], [-122.410475, 37.80937], [-122.411323, 37.810958], [-122.410669, 37.811379], [-122.410203, 37.811311], [-122.409973, 37.810966], [-122.410179, 37.810095], [-122.409611, 37.809141], [-122.409242, 37.809049], [-122.409109, 37.808848], [-122.409089, 37.808138], [-122.405774, 37.806775], [-122.405899, 37.806399], [-122.405462, 37.806107], [-122.405175, 37.804795], [-122.40596, 37.80469], [-122.405752, 37.803725], [-122.404953, 37.803822], [-122.405067, 37.802885], [-122.403175, 37.803098], [-122.402791, 37.801265], [-122.4036, 37.801195], [-122.403549, 37.800548], [-122.404359, 37.800576], [-122.404329, 37.800423], [-122.404265, 37.80013], [-122.403422, 37.800209], [-122.403765, 37.799746], [-122.403656, 37.799212], [-122.402423, 37.799369], [-122.401864, 37.796638], [-122.405152, 37.796213], [-122.404959, 37.795337], [-122.405526, 37.795292], [-122.40568, 37.796152], [-122.406649, 37.796027], [-122.406591, 37.795697], [-122.407014, 37.795587], [-122.407091, 37.79597], [-122.411087, 37.795467], [-122.411024, 37.795145], [-122.411484, 37.795033], [-122.411553, 37.795409], [-122.414883, 37.79503], [-122.415574, 37.798688], [-122.417224, 37.798494], [-122.41741, 37.799405], [-122.418226, 37.799295], [-122.418252, 37.799884], [-122.417548, 37.799967], [-122.417814, 37.80132], [-122.419075, 37.801144], [-122.419167, 37.801559], [-122.417893, 37.80172], [-122.418129, 37.803168]]]],
                    "type": "MultiPolygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94133",
            "properties": {
                "id": "94133",
                "name": "North Beach/Chinatown"
            },
            "type": "Feature"
        },
        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.405883, 37.785718], [-122.426242, 37.769644], [-122.428262, 37.769541], [-122.429573, 37.776045], [-122.4294, 37.776267], [-122.429593, 37.776526], [-122.429983, 37.778864], [-122.426829, 37.779265], [-122.427427, 37.782055], [-122.414256, 37.783728], [-122.414805, 37.786523], [-122.413165, 37.786726], [-122.413356, 37.787657], [-122.411712, 37.78787], [-122.411913, 37.788812], [-122.408655, 37.789244], [-122.408244, 37.787369], [-122.406602, 37.787583], [-122.406236, 37.785793], [-122.405883, 37.785718]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94102",
            "properties": {
                "id": "94102",
                "name": "Hayes Valley/Tenderloin/North of Market"
            },
            "type": "Feature"
        }, {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.398941, 37.783785], [-122.405629, 37.778502], [-122.399425, 37.773612], [-122.403723, 37.770182], [-122.404003, 37.77018], [-122.403477, 37.769842], [-122.402105, 37.769912], [-122.402091, 37.769716], [-122.401685, 37.769721], [-122.401768, 37.769145], [-122.402021, 37.768998], [-122.401851, 37.767416], [-122.400881, 37.767518], [-122.400915, 37.768096], [-122.40001, 37.767614], [-122.400422, 37.767291], [-122.3998, 37.766807], [-122.399688, 37.765005], [-122.407431, 37.764497], [-122.407553, 37.765798], [-122.419459, 37.765089], [-122.421248, 37.764947], [-122.421031, 37.76335], [-122.42173, 37.763304], [-122.421885, 37.764908], [-122.426453, 37.764634], [-122.426897, 37.769107], [-122.42245, 37.772761], [-122.403427, 37.787676], [-122.40333, 37.787336], [-122.401497, 37.785824], [-122.39999, 37.787004], [-122.399523, 37.786631], [-122.400955, 37.785389], [-122.398941, 37.783785]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94103",
            "properties": {
                "id": "94103",
                "name": "South of Market"
            },
            "type": "Feature"
        },

        {
            "geometry": {
                "geometries": [{
                    "coordinates": [[[-122.391701, 37.794113], [-122.392429, 37.793835], [-122.393875, 37.795248], [-122.399156, 37.791051], [-122.399607, 37.791317], [-122.400146, 37.79415], [-122.404629, 37.79358], [-122.405152, 37.796213], [-122.401864, 37.796638], [-122.402423, 37.799369], [-122.403656, 37.799212], [-122.403765, 37.799746], [-122.403422, 37.800209], [-122.404265, 37.80013], [-122.404329, 37.800423], [-122.404359, 37.800576], [-122.403549, 37.800548], [-122.4036, 37.801195], [-122.402791, 37.801265], [-122.403175, 37.803098], [-122.405067, 37.802885], [-122.404953, 37.803822], [-122.405752, 37.803725], [-122.40596, 37.80469], [-122.405175, 37.804795], [-122.405462, 37.806107], [-122.405899, 37.806399], [-122.405774, 37.806775], [-122.409089, 37.808138], [-122.409004, 37.808563], [-122.407936, 37.808146], [-122.407617, 37.808244], [-122.407477, 37.808085], [-122.406554, 37.807891], [-122.406816, 37.810064], [-122.406209, 37.810103], [-122.405976, 37.807252], [-122.405313, 37.806883], [-122.404321, 37.808927], [-122.403972, 37.808829], [-122.404712, 37.807015], [-122.403955, 37.806592], [-122.402774, 37.808053], [-122.402375, 37.807896], [-122.403406, 37.806516], [-122.402824, 37.806076], [-122.400944, 37.807679], [-122.400408, 37.807307], [-122.40097, 37.803579], [-122.400512, 37.8035], [-122.39855, 37.80465], [-122.398217, 37.804315], [-122.399938, 37.803283], [-122.399597, 37.802882], [-122.397818, 37.803862], [-122.397518, 37.803526], [-122.399718, 37.802209], [-122.399419, 37.801867], [-122.399203, 37.801906], [-122.397115, 37.803089], [-122.39613, 37.801975], [-122.3984, 37.80072], [-122.398001, 37.800267], [-122.395772, 37.801535], [-122.39544, 37.80118], [-122.397667, 37.7999], [-122.396766, 37.798884], [-122.39658, 37.798852], [-122.394503, 37.800155], [-122.394306, 37.80013], [-122.394252, 37.799996], [-122.396516, 37.798686], [-122.395855, 37.797941], [-122.395655, 37.797922], [-122.393825, 37.798956], [-122.393551, 37.798652], [-122.395468, 37.797463], [-122.395024, 37.797575], [-122.394882, 37.797427], [-122.39512, 37.797145], [-122.393219, 37.798276], [-122.392969, 37.797941], [-122.394774, 37.796778], [-122.394682, 37.796659], [-122.3942, 37.796922], [-122.393041, 37.795634], [-122.391593, 37.796229], [-122.391211, 37.795822], [-122.392391, 37.794856], [-122.392292, 37.794737], [-122.391934, 37.794842], [-122.391668, 37.79458], [-122.391934, 37.794376], [-122.391701, 37.794113]]],
                    "type": "Polygon"
                }],
                "type": "GeometryCollection"
            },
            "id": "94111",
            "properties": {
                "id": "94111",
                "name": "Potrero Hill"
            },
            "type": "Feature"
        }],
    "type": "FeatureCollection"
};
    var width = 800, height = 800;

    var map = d3.select("#station_data").append("svg").attr("width", width).attr("height", height);
    var projection = d3.geo.mercator().scale(1).translate([0, 0]).precision(0);
    var path = d3.geo.path().projection(projection);
    var bounds = path.bounds(data);
    var sequentialColors = ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#ff0000'];
    var percentScale = d3.scaleLinear().domain([0, 25, 50, 75, 100]).range(sequentialColors);

    xScale = width / Math.abs(bounds[1][0] - bounds[0][0]);
    yScale = height / Math.abs(bounds[1][1] - bounds[0][1]);
    scale = xScale < yScale ? xScale : yScale;

    var transl = [(width - scale * (bounds[1][0] + bounds[0][0])) / 2, (height - scale * (bounds[1][1] + bounds[0][1])) / 2];
    projection.scale(scale).translate(transl);

    map.selectAll("path").data(data.features).enter().append("path").attr("d", path)
        .style("fill", "#363a44")
        .style("stroke", "#17181c");

    var rawStationData;
    d3.csv("station_data.csv", function (error, data) {
        rawStationData = data;

        var radius = 3;
        var offset = 3;

        // Datapoints / Processing
        rawStationData.forEach(function (place) {
            // Station points
            map.append("circle")
                .attr("cx", projection([place.long, place.lat])[0])
                .attr("cy", projection([place.long, place.lat])[1])
                .attr("r", radius)
                .attr("fill", "#ffffff");

            // Labels
            map.append("text")
                .attr("x", projection([place.long, place.lat])[0] + offset)
                .attr("y", projection([place.long, place.lat])[1] - offset)
                .text(place.name)
                .attr("font-size", 10)
                .attr("fill", "#ffffff");
        });
    });

    var rawTripData;
    d3.csv("trip_data.csv" , function (error, data) {
      rawTripData = data;
        //Routes
      rawTripData.forEach(function (route) {
          map.append("line")
              .attr("x1", projection([route.start_lon, route.start_lat])[0])
              .attr("x2", projection([route.end_lon, route.end_lat])[0])
              .attr("y1", projection([route.start_lon, route.start_lat])[1])
              .attr("y2", projection([route.end_lon, route.end_lat])[1])
              .style("stroke-width", .08)
              .style("stroke", function () {
                 return percentScale(route.count);
              })
      });

    });

    //Legend
map.append("rect").attr("x", 600).attr("y", 660).attr("width", 50).attr("height", 5).attr("fill", "#fee0d2");
map.append("rect").attr("x", 650).attr("y", 660).attr("width", 50).attr("height", 5).attr("fill", "#fb6a4a");
map.append("rect").attr("x", 700).attr("y", 660).attr("width", 50).attr("height", 5).attr("fill", "#a50f15");

map.append("text").text("Less Frequent").attr("x", 580).attr("y", 650).attr("font-size", 12).attr("fill", "#fee0d2") ;
map.append("text").text("More Frequent").attr("x", 720).attr("y", 650).attr("font-size", 12).attr("fill", "#a50f15");